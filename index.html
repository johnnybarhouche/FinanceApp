<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Credit Card Dues Tracker</title>
  <style>
    :root { --bg:#0b0f14; --card:#131f2c; --text:#e6edf3; --muted:#9aa7b5; --accent:#4f46e5; }
    *{box-sizing:border-box}
    html,body{-webkit-text-size-adjust:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:calc(env(safe-area-inset-top,0px)+16px) 16px calc(env(safe-area-inset-bottom,0px)+24px)}
    h1{font-size:clamp(22px,3vw,28px);margin:0 0 18px}
    .grid{display:grid;gap:16px;grid-template-columns:2fr 1fr}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{border-radius:12px;border:1px solid #223247;background:#0f1722;color:var(--text);padding:12px 14px;font-size:16px;min-height:44px}
    button{border:1px solid #2a3b57;cursor:pointer;-webkit-appearance:none;appearance:none}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px 12px;text-align:left}
    th{color:var(--muted);font-weight:600;font-size:12px}
    tr{background:#0f1824}
    tr td:first-child, tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child, tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px}
    .pill.due{background:#1a2432;color:#f8fafc;border:1px solid #2b3b55}
    .pill.paid{background:#0f2a1a;border:1px solid #1f5c3b;color:#c7f9d4}
    .totals{display:flex;flex-direction:column;margin-top:8px;gap:4px}
    .total{font-size:18px;font-weight:700}
    .muted{color:var(--muted)}
    .collapsible-header{cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;user-select:none}
    .collapsible-content{display:none;margin-top:8px}
    .btn{padding:12px 14px;border-radius:12px}
    .btn.primary{background:var(--accent);border-color:transparent}
    .month-controls button{width:44px;height:44px;border-radius:12px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ’³ Credit Card Dues Tracker</h1>
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row month-controls">
            <label for="month">Month</label>
            <input type="month" id="month" />
            <button id="btnPrev" aria-label="Previous month">â—€</button>
            <button id="btnNext" aria-label="Next month">â–¶</button>
          </div>
          <div class="row">
            <button class="btn primary" id="btnAddPayment">Add/Update Payment</button>
            <button class="btn" id="btnMarkAllPaid">Mark All Paid</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Card</th>
              <th>Amount Due</th>
              <th>Due Date</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="paymentsTbody"></tbody>
        </table>
        <div class="totals">
          <div class="total" id="totalDue">Total Due: 0</div>
          <div class="total" id="totalPaid">Total Paid: 0</div>
          <div class="total" id="totalRemaining">Remaining: 0</div>
        </div>
      </div>

      <div class="card">
        <div class="collapsible-header" onclick="toggleSection('cardsSection', this)">Cards <span>â–¼</span></div>
        <div id="cardsSection" class="collapsible-content">
          <div class="row">
            <input id="ccName" placeholder="Card name" />
            <input id="ccLast4" placeholder="Last 4" maxlength="4" />
            <input id="ccLimit" type="number" placeholder="Limit" inputmode="decimal" />
            <button class="btn primary" id="btnAddCard">Add Card</button>
          </div>
          <div id="cardsList" style="margin-top:12px"></div>
        </div>
        <div class="collapsible-header" onclick="toggleSection('dataSection', this)">Data <span>â–¼</span></div>
        <div id="dataSection" class="collapsible-content">
          <button class="btn" id="btnExport">Export CSV</button>
          <button class="btn" id="btnReset">Reset All</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const STORE_KEY = 'ccapp_v3';
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const fmt0 = n => new Intl.NumberFormat(undefined,{maximumFractionDigits:0}).format(Math.round(+n||0));
    const ym = d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; // local, avoids UTC jumps

    let store;
    try{ store = JSON.parse(localStorage.getItem(STORE_KEY)) || {cards:[],payments:{}} }catch(e){ store = {cards:[],payments:{}} }
    function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }
    function ensureMonth(m){ if(!store.payments[m]) store.payments[m]={}; }

    function render(){
      const m=$('#month').value; ensureMonth(m);
      const tbody=$('#paymentsTbody'); tbody.innerHTML='';
      let total=0, paid=0;
      store.cards.forEach(c=>{
        if(!store.payments[m][c.id]) store.payments[m][c.id]={amount:'',dueDate:'',paid:false};
        const p=store.payments[m][c.id];
        total += +p.amount||0; if(p.paid) paid += +p.amount||0;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(c.name)}${c.last4?` â€¢â€¢â€¢â€¢ ${escapeHtml(c.last4)}`:''}</td>
          <td><input type='number' inputmode='decimal' step='0.01' data-amount='${c.id}' value='${p.amount}' /></td>
          <td><input type='date' data-date='${c.id}' value='${p.dueDate||''}' /></td>
          <td>${p.paid?'<span class="pill paid">Paid</span>':'<span class="pill due">Unpaid</span>'}</td>
          <td><button class='btn' data-togglepaid='${c.id}'>${p.paid?'Unmark':'Mark Paid'}</button></td>`;
        tbody.appendChild(tr);
      });
      $('#totalDue').textContent=`Total Due: ${fmt0(total)}`;
      $('#totalPaid').textContent=`Total Paid: ${fmt0(paid)}`;
      $('#totalRemaining').textContent=`Remaining: ${fmt0(total-paid)}`;

      // Wire inputs
      $$('input[data-amount]').forEach(inp=> inp.onchange=e=>{
        const m=$('#month').value; const id=e.target.dataset.amount;
        ensureMonth(m); const entry=store.payments[m][id]||{amount:'',dueDate:'',paid:false};
        entry.amount = +e.target.value||0; store.payments[m][id]=entry; save(); render();
      });
      $$('input[data-date]').forEach(inp=> inp.onchange=e=>{
        const m=$('#month').value; const id=e.target.dataset.date;
        ensureMonth(m); const entry=store.payments[m][id]||{amount:'',dueDate:'',paid:false};
        entry.dueDate = e.target.value; store.payments[m][id]=entry; save(); render();
      });
      $$('button[data-togglepaid]').forEach(btn=> btn.onclick=e=>{
        const m=$('#month').value; const id=e.target.dataset.togglepaid;
        const entry=store.payments[m][id]; entry.paid=!entry.paid; save(); render();
      });
    }

    $('#btnAddCard').onclick=()=>{
      const name=$('#ccName').value.trim(); if(!name) return alert('Enter card name');
      const last4=$('#ccLast4').value.trim(); const limit=$('#ccLimit').value.trim();
      store.cards.push({id:Date.now().toString(36)+Math.random().toString(36).slice(2,7), name, last4, limit});
      save(); $('#ccName').value=''; $('#ccLast4').value=''; $('#ccLimit').value=''; render();
    };

    function shiftMonth(delta){
      const val=$('#month').value; let y,m,base;
      if(val && /^\d{4}-\d{2}$/.test(val)){ [y,m]=val.split('-').map(Number); base=new Date(y,m-1,1); }
      else { base=new Date(); base.setDate(1); }
      base.setMonth(base.getMonth()+delta);
      $('#month').value = ym(base); render();
    }

    $('#btnPrev').addEventListener('click', ()=>shiftMonth(-1));
    $('#btnNext').addEventListener('click', ()=>shiftMonth(1));

    $('#btnAddPayment').onclick=()=>{
      if(store.cards.length===0) return alert('Add a card first.');
      const m=$('#month').value; ensureMonth(m);
      const target=store.cards[0];
      const current=store.payments[m][target.id]||{};
      const amt=prompt(`Amount due for ${target.name} (${m})`, current.amount??''); if(amt===null) return;
      const due=prompt('Due date (YYYY-MM-DD)', current.dueDate??'');
      store.payments[m][target.id]={amount:+amt||0,dueDate:due||'',paid:false}; save(); render();
    };

    $('#btnMarkAllPaid').onclick=()=>{
      const m=$('#month').value; ensureMonth(m);
      if(!confirm('Mark all visible payments as PAID?')) return;
      Object.keys(store.payments[m]).forEach(id=> store.payments[m][id].paid=true); save(); render();
    };

    $('#btnExport').onclick=()=>{
      const m=$('#month').value; ensureMonth(m);
      const rows=[["month","card","last4","amount","due_date","paid"]];
      store.cards.forEach(c=>{
        const p=store.payments[m][c.id]||{amount:'',dueDate:'',paid:false};
        rows.push([m,c.name,c.last4||'',String(p.amount||''),p.dueDate||'',p.paid?'yes':'no']);
      });
      const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`ccapp-${m}.csv`; a.click();
    };

    $('#btnReset').onclick=()=>{ if(confirm('Reset ALL data?')){ store={cards:[],payments:{}}; save(); render(); }};

    function toggleSection(id, header){
      const el=document.getElementById(id); const open=el.style.display==='block';
      el.style.display=open?'none':'block'; header.querySelector('span').textContent=open?'â–¼':'â–²';
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // Init
    (function init(){
      const d=new Date(); d.setDate(1); $('#month').value=ym(d); render();
      // Open sections by default on first load
      toggleSection('cardsSection', document.querySelector('.collapsible-header'));
      toggleSection('dataSection', document.querySelectorAll('.collapsible-header')[1]);
    })();
  </script>
</body>
</html>
